name: GenAI-QA Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  genai-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Find a source file to test (adjust the pattern to your repo)
      - name: Select a code file
        id: pick
        run: |
          FILE=$(find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.java" \) | head -1)
          if [ -z "$FILE" ]; then echo "No code file found"; exit 1; fi
          echo "file=$FILE" >> $GITHUB_OUTPUT

      - name: Read code content
        id: read
        run: |
          CODE=$(cat "${{ steps.pick.outputs.file }}" | python -c "import sys,json; print(json.dumps(sys.stdin.read()))")
          echo "code=$CODE" >> $GITHUB_OUTPUT

      - name: Generate tests via backend
        id: gen
        run: |
          RESP=$(curl -sS -X POST "$BACKEND_URL/api/generate-tests" \
            -H "Content-Type: application/json" \
            -d "{\"message\":${{ steps.read.outputs.code }},\"language\":\"auto\",\"context\":\"CI run\"}")
          echo "$RESP" | jq .
          REQ_ID=$(echo "$RESP" | jq -r '.request_id')
          echo "req_id=$REQ_ID" >> $GITHUB_OUTPUT
          echo "$RESP" > generated_tests.json
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}

      - name: Execute tests via backend
        id: run_tests
        run: |
          RESP=$(curl -sS -X POST "$BACKEND_URL/api/run-tests" \
            -H "Content-Type: application/json" \
            -d "{\"request_id\":\"${{ steps.gen.outputs.req_id }}\"}")
          echo "$RESP" | jq .
          EXEC_ID=$(echo "$RESP" | jq -r '.execution_id')
          echo "exec_id=$EXEC_ID" >> $GITHUB_OUTPUT
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}

      - name: Download JUnit XML
        run: |
          curl -sS "$BACKEND_URL/api/results/${{ steps.run_tests.outputs.exec_id }}/junit" \
            -o junit-results.xml
          ls -l junit-results.xml
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}

      - name: Publish test report to PR
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: junit-results.xml

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: genai-qa-results
          path: |
            junit-results.xml
            generated_tests.json