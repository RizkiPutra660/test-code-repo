name: GenAI-QA Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  genai-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Find a source file (adjust patterns if needed)
      - name: Select a code file
        id: pick
        shell: bash
        run: |
          set -euo pipefail
          FILE=$(find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.java" \) | head -1)
          if [ -z "$FILE" ]; then echo "No code file found"; exit 1; fi
          echo "file=$FILE" >> "$GITHUB_OUTPUT"

      # Read file as base64 to avoid JSON/shell escaping issues
      - name: Read code content (base64)
        id: read
        shell: bash
        run: |
          set -euo pipefail
          CODE_B64=$(base64 -w0 "${{ steps.pick.outputs.file }}")
          echo "code_b64=$CODE_B64" >> "$GITHUB_OUTPUT"

      - name: Generate tests via backend
        id: gen
        shell: bash
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: |
          set -euo pipefail
          CODE=$(echo "${{ steps.read.outputs.code_b64 }}" | base64 -d)
          export CODE
          PAYLOAD=$(python - <<'PY'
          import json, os
          code = os.environ["CODE"]
          print(json.dumps({"message": code, "language": "auto", "context": "CI run"}))
          PY
          )
          RESP=$(curl -sS -X POST "$BACKEND_URL/api/generate-tests" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")
          echo "$RESP" | jq .
          REQ_ID=$(echo "$RESP" | jq -r '.request_id')
          echo "req_id=$REQ_ID" >> "$GITHUB_OUTPUT"
          echo "$RESP" > generated_tests.json

      - name: Execute tests via backend
        id: run_tests
        shell: bash
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: |
          set -euo pipefail
          RESP=$(curl -sS -X POST "$BACKEND_URL/api/run-tests" \
            -H "Content-Type: application/json" \
            -d "{\"request_id\":\"${{ steps.gen.outputs.req_id }}\"}")
          echo "$RESP" | jq .
          EXEC_ID=$(echo "$RESP" | jq -r '.execution_id')
          echo "exec_id=$EXEC_ID" >> "$GITHUB_OUTPUT"

      - name: Download JUnit XML
        shell: bash
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: |
          set -euo pipefail
          curl -sS "$BACKEND_URL/api/results/${{ steps.run_tests.outputs.exec_id }}/junit" -o junit-results.xml
          ls -l junit-results.xml

      - name: Publish test report to PR
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: junit-results.xml

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: genai-qa-results
          path: |
            junit-results.xml
            generated_tests.json